import { createContext, useCallback, useContext, useMemo, useState } from 'react';

const I18nContext = createContext(null);

const translations = {
  en: {
    sidebar: {
      studio: 'Pilates Studio',
      vision: 'Vision & Progress',
      dashboard: 'Dashboard',
      students: 'Student Management',
      instructors: 'Instructor Management',
      schedule: 'Schedule',
      analysis: 'Postural Analysis',
      plans: 'Training Plans',
      language: 'Language',
      darkMode: 'Dark Mode',
      lightMode: 'Light Mode',
    },
    common: {
      save: 'Save',
      saveChanges: 'Save Changes',
      cancel: 'Cancel',
      close: 'Close',
      delete: 'Delete',
      edit: 'Edit',
      email: 'Email',
      back: 'Back',
      nextStep: 'Next Step',
      actions: 'Actions',
      loading: 'Loading...',
      noData: 'No data found.',
    },
    dashboard: {
      subtitle: 'Overview of Pilates Vision & Progress operations.',
      activeStudents: 'Active Students',
      pendingAssessments: 'Pending Assessments',
      sessionsToday: 'Sessions Today',
      avgScore: 'Average Postural Score',
      todaySchedule: "Today's Schedule",
      time: 'Time',
      student: 'Student',
      focus: 'Focus',
      focusCore: 'Core Control',
      focusSpine: 'Spine Mobility',
      focusPosture: 'Posture Alignment',
      focusBreath: 'Breath & Stability',
    },
    student: {
      title: 'Student Management',
      subtitle: 'Register students and keep their medical profile updated.',
      stepPersonal: 'Personal Info',
      stepMedical: 'Medical History',
      stepGoals: 'Goals',
      name: 'Name',
      cpf: 'Tax ID (CPF)',
      dob: 'Date of Birth',
      phone: 'Phone',
      medicalNotes: 'Medical Notes',
      goals: 'Goals',
      medicalPlaceholder: 'Example: Herniated disc at L4-L5, mild knee pain.',
      goalsPlaceholder: 'Example: Improve posture and reduce neck tension.',
      saveStudent: 'Save Student',
      saving: 'Saving...',
      registered: 'Student registered successfully.',
      registeredStudents: 'Registered Students',
      searchPlaceholder: 'Search by name, CPF, or phone',
      noStudents: 'No students found.',
      searching: 'Searching students...',
      editStudent: 'Edit Student',
      deleteConfirm: 'Delete this student? This action cannot be undone.',
      deleteLoading: 'Deleting...',
      updated: 'Student updated successfully.',
      deleted: 'Student deleted successfully.',
      saveError: 'Could not save student.',
      updateError: 'Could not update student.',
      deleteError: 'Could not delete student.',
      invalidForm: 'Please complete required fields with valid values.',
    },
    instructor: {
      title: 'Instructor Management',
      subtitle: 'Register and manage Pilates instructors.',
      register: 'Register Instructor',
      registered: 'Registered Instructors',
      specialty: 'Specialty',
      notes: 'Notes',
      saveInstructor: 'Save Instructor',
      saved: 'Instructor saved successfully.',
      noInstructors: 'No instructors yet.',
      loadingInstructors: 'Loading instructors...',
      editInstructor: 'Edit Instructor',
      deleteConfirm: 'Delete this instructor? This action cannot be undone.',
      deleteLoading: 'Deleting...',
      saveError: 'Could not save instructor.',
      updateError: 'Could not update instructor.',
      deleteError: 'Could not delete instructor.',
      updated: 'Instructor updated successfully.',
      deleted: 'Instructor deleted successfully.',
      general: 'General Pilates',
    },
    schedule: {
      title: 'Schedule',
      subtitle: 'Weekly planning board for student sessions.',
      calendarView: 'Calendar View',
      helper: 'Click empty slots to book and booked slots for details.',
      clickToBook: 'Click any slot to book',
      statusBooked: 'Booked',
      statusCompleted: 'Completed',
      statusCanceled: 'Canceled',
      book: 'Book',
      loading: 'Loading schedule...',
      bookSession: 'Book Session',
      searchStudent: 'Search Student',
      searchStudentPlaceholder: 'Type name, CPF, or phone',
      noStudents: 'No students found.',
      instructor: 'Instructor',
      confirmBooking: 'Confirm Booking',
      booking: 'Booking...',
      defaultNote: 'Scheduled from calendar view',
      bookingSuccess: 'Appointment booked successfully.',
      bookingError: 'Could not create appointment.',
      invalidBook: 'Select student, instructor, and a valid slot.',
      details: 'Appointment Details',
      time: 'Time',
      date: 'Date',
      status: 'Status',
      student: 'Student',
      dayMon: 'Monday',
      dayTue: 'Tuesday',
      dayWed: 'Wednesday',
      dayThu: 'Thursday',
      dayFri: 'Friday',
      unknown: 'Unknown',
      deleting: 'Deleting...',
      deleteConfirm: 'Delete this appointment? This action cannot be undone.',
      deleteSuccess: 'Appointment deleted successfully.',
      deleteError: 'Could not delete appointment.',
      updateSuccess: 'Appointment updated successfully.',
      updateError: 'Could not update appointment.',
      invalidEdit: 'Select a valid date, time, and status.',
    },
    analysis: {
      title: 'Postural Analysis',
      subtitle: 'Upload student imagery and run AI-assisted posture insights.',
      previewAlt: 'Uploaded posture image preview',
      uploadCta: 'Click to upload a posture image',
      selectedFile: 'Selected: {{name}}',
      analyze: 'Analyze Posture',
      analyzing: 'Analyzing...',
      findings: 'AI Findings',
      status: 'Status',
      score: 'Score',
      deviations: 'Detected Deviations:',
      empty: 'Run an analysis to view the postural report.',
      uploadRequired: 'Upload an image before running analysis.',
      analysisSuccess: 'Analysis completed successfully.',
      analysisError: 'Analysis failed.',
    },
    plans: {
      title: 'Training Plans',
      subtitle: 'Prepare personalized routines based on assessments and goals.',
      selectStudent: 'Select Student',
      loadingStudents: 'Loading students...',
      chooseStudent: 'Choose a student',
      profile: 'Student Profile',
      age: 'Age',
      goal: 'Goal',
      notInformed: 'Not informed',
      description: 'Prototype area for future smart training plan recommendations.',
      generate: 'Generate Plan',
      generating: 'Generating...',
      loadError: 'Could not load students.',
      generated: 'Prototype action: Training plan generated for {{name}}.',
    },
  },
  pt: {
    sidebar: {
      studio: 'Estúdio de Pilates',
      vision: 'Vision & Progress',
      dashboard: 'Painel',
      students: 'Gestão de Alunos',
      instructors: 'Gestão de Instrutores',
      schedule: 'Agenda',
      analysis: 'Análise Postural',
      plans: 'Planos de Treino',
      language: 'Idioma',
      darkMode: 'Modo Escuro',
      lightMode: 'Modo Claro',
    },
    common: {
      save: 'Salvar',
      saveChanges: 'Salvar Alterações',
      cancel: 'Cancelar',
      close: 'Fechar',
      delete: 'Excluir',
      edit: 'Editar',
      email: 'E-mail',
      back: 'Voltar',
      nextStep: 'Próxima Etapa',
      actions: 'Ações',
      loading: 'Carregando...',
      noData: 'Nenhum dado encontrado.',
    },
    dashboard: {
      subtitle: 'Visão geral das operações do Pilates Vision & Progress.',
      activeStudents: 'Alunos Ativos',
      pendingAssessments: 'Avaliações Pendentes',
      sessionsToday: 'Sessões Hoje',
      avgScore: 'Média de Pontuação Postural',
      todaySchedule: 'Agenda de Hoje',
      time: 'Horário',
      student: 'Aluno',
      focus: 'Foco',
      focusCore: 'Controle de Core',
      focusSpine: 'Mobilidade da Coluna',
      focusPosture: 'Alinhamento Postural',
      focusBreath: 'Respiração e Estabilidade',
    },
    student: {
      title: 'Gestão de Alunos',
      subtitle: 'Cadastre alunos e mantenha o perfil médico atualizado.',
      stepPersonal: 'Informações Pessoais',
      stepMedical: 'Histórico Médico',
      stepGoals: 'Objetivos',
      name: 'Nome',
      cpf: 'CPF',
      dob: 'Data de Nascimento',
      phone: 'Telefone',
      medicalNotes: 'Observações Médicas',
      goals: 'Objetivos',
      medicalPlaceholder: 'Exemplo: Hérnia de disco em L4-L5, dor leve no joelho.',
      goalsPlaceholder: 'Exemplo: Melhorar postura e reduzir tensão cervical.',
      saveStudent: 'Salvar Aluno',
      saving: 'Salvando...',
      registered: 'Aluno cadastrado com sucesso.',
      registeredStudents: 'Alunos Cadastrados',
      searchPlaceholder: 'Buscar por nome, CPF ou telefone',
      noStudents: 'Nenhum aluno encontrado.',
      searching: 'Buscando alunos...',
      editStudent: 'Editar Aluno',
      deleteConfirm: 'Excluir este aluno? Esta ação não pode ser desfeita.',
      deleteLoading: 'Excluindo...',
      updated: 'Aluno atualizado com sucesso.',
      deleted: 'Aluno excluído com sucesso.',
      saveError: 'Não foi possível salvar o aluno.',
      updateError: 'Não foi possível atualizar o aluno.',
      deleteError: 'Não foi possível excluir o aluno.',
      invalidForm: 'Preencha os campos obrigatórios com valores válidos.',
    },
    instructor: {
      title: 'Gestão de Instrutores',
      subtitle: 'Cadastre e gerencie instrutores de Pilates.',
      register: 'Cadastrar Instrutor',
      registered: 'Instrutores Cadastrados',
      specialty: 'Especialidade',
      notes: 'Observações',
      saveInstructor: 'Salvar Instrutor',
      saved: 'Instrutor salvo com sucesso.',
      noInstructors: 'Nenhum instrutor cadastrado.',
      loadingInstructors: 'Carregando instrutores...',
      editInstructor: 'Editar Instrutor',
      deleteConfirm: 'Excluir este instrutor? Esta ação não pode ser desfeita.',
      deleteLoading: 'Excluindo...',
      saveError: 'Não foi possível salvar o instrutor.',
      updateError: 'Não foi possível atualizar o instrutor.',
      deleteError: 'Não foi possível excluir o instrutor.',
      updated: 'Instrutor atualizado com sucesso.',
      deleted: 'Instrutor excluído com sucesso.',
      general: 'Pilates Geral',
    },
    schedule: {
      title: 'Agenda',
      subtitle: 'Quadro semanal de planejamento das sessões.',
      calendarView: 'Visão de Calendário',
      helper: 'Clique em horários livres para agendar e em horários ocupados para detalhes.',
      clickToBook: 'Clique em qualquer horário para agendar',
      statusBooked: 'Agendado',
      statusCompleted: 'Concluído',
      statusCanceled: 'Cancelado',
      book: 'Agendar',
      loading: 'Carregando agenda...',
      bookSession: 'Agendar Sessão',
      searchStudent: 'Buscar Aluno',
      searchStudentPlaceholder: 'Digite nome, CPF ou telefone',
      noStudents: 'Nenhum aluno encontrado.',
      instructor: 'Instrutor',
      confirmBooking: 'Confirmar Agendamento',
      booking: 'Agendando...',
      defaultNote: 'Agendado pela visão de calendário',
      bookingSuccess: 'Agendamento realizado com sucesso.',
      bookingError: 'Não foi possível criar o agendamento.',
      invalidBook: 'Selecione aluno, instrutor e um horário válido.',
      details: 'Detalhes do Agendamento',
      time: 'Horário',
      date: 'Data',
      status: 'Status',
      student: 'Aluno',
      dayMon: 'Segunda',
      dayTue: 'Terça',
      dayWed: 'Quarta',
      dayThu: 'Quinta',
      dayFri: 'Sexta',
      unknown: 'Desconhecido',
      deleting: 'Excluindo...',
      deleteConfirm: 'Excluir este agendamento? Esta ação não pode ser desfeita.',
      deleteSuccess: 'Agendamento excluído com sucesso.',
      deleteError: 'Não foi possível excluir o agendamento.',
      updateSuccess: 'Agendamento atualizado com sucesso.',
      updateError: 'Não foi possível atualizar o agendamento.',
      invalidEdit: 'Selecione data, hora e status válidos.',
    },
    analysis: {
      title: 'Análise Postural',
      subtitle: 'Envie imagens do aluno e execute insights posturais assistidos por IA.',
      previewAlt: 'Prévia da imagem postural enviada',
      uploadCta: 'Clique para enviar uma imagem postural',
      selectedFile: 'Selecionado: {{name}}',
      analyze: 'Analisar Postura',
      analyzing: 'Analisando...',
      findings: 'Resultados da IA',
      status: 'Status',
      score: 'Pontuação',
      deviations: 'Desvios Detectados:',
      empty: 'Execute uma análise para visualizar o relatório postural.',
      uploadRequired: 'Envie uma imagem antes de executar a análise.',
      analysisSuccess: 'Análise concluída com sucesso.',
      analysisError: 'Falha na análise.',
    },
    plans: {
      title: 'Planos de Treino',
      subtitle: 'Prepare rotinas personalizadas com base em avaliações e objetivos.',
      selectStudent: 'Selecionar Aluno',
      loadingStudents: 'Carregando alunos...',
      chooseStudent: 'Escolha um aluno',
      profile: 'Perfil do Aluno',
      age: 'Idade',
      goal: 'Objetivo',
      notInformed: 'Não informado',
      description: 'Área de protótipo para futuras recomendações inteligentes de treino.',
      generate: 'Gerar Plano',
      generating: 'Gerando...',
      loadError: 'Não foi possível carregar os alunos.',
      generated: 'Ação de protótipo: plano de treino gerado para {{name}}.',
    },
  },
};

function getValueByPath(obj, path) {
  return path.split('.').reduce((acc, part) => (acc && acc[part] !== undefined ? acc[part] : undefined), obj);
}

function formatText(template, vars) {
  if (!vars) {
    return template;
  }
  return Object.entries(vars).reduce((text, [key, value]) => text.replaceAll(`{{${key}}}`, String(value)), template);
}

export function I18nProvider({ children }) {
  const [language, setLanguage] = useState(() => {
    const saved = localStorage.getItem('pilates-language');
    if (saved === 'en' || saved === 'pt') {
      return saved;
    }
    return navigator.language.toLowerCase().startsWith('pt') ? 'pt' : 'en';
  });

  const changeLanguage = useCallback((nextLanguage) => {
    if (nextLanguage !== 'en' && nextLanguage !== 'pt') {
      return;
    }
    setLanguage(nextLanguage);
    localStorage.setItem('pilates-language', nextLanguage);
  }, []);

  const t = useCallback(
    (key, vars) => {
      const current = getValueByPath(translations[language], key);
      const fallback = getValueByPath(translations.en, key);
      const value = current ?? fallback ?? key;
      return typeof value === 'string' ? formatText(value, vars) : value;
    },
    [language]
  );

  const value = useMemo(() => ({ language, changeLanguage, t }), [language, changeLanguage, t]);
  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error('useI18n must be used inside I18nProvider');
  }
  return context;
}
